services:
  - name: goalsniper
    installCommand: pip install -U pip && pip install -r requirements.txt
    startCommand: gunicorn -c gunicorn_conf.py main:app

    env:
      PYTHONUNBUFFERED: "1"
      PYTHON_VERSION: "3.11"
      TZ: "Europe/Berlin"

    # Give the app + DB more time during cold starts so Railway doesn't bounce it
    healthcheck:
      path: /health
      interval: 15
      timeout: 20
      retries: 30

    autoDeploy: false  # keep manual; prevent redeploys on every env var edit

    variables:
      # ───── Required ─────
      - key: DATABASE_URL
        required: true
      - key: APIFOOTBALL_KEY
        required: true

      # Optional API base (we set an explicit default so it's not "required")
      - key: APISPORTS_BASE_URL
        value: "https://v3.football.api-sports.io"

      # ───── Scheduler / jobs ─────
      - key: RUN_SCHEDULER
        value: "1"
      - key: SCHEDULER_LEADER
        value: "1"          # set "0" on any additional web processes you scale out
      - key: SCAN_INTERVAL_SEC
        value: "300"
      - key: BACKFILL_EVERY_MIN
        value: "15"
      - key: TRAIN_ENABLE
        value: "1"
      - key: AUTO_TUNE_ENABLE
        value: "1"
      - key: DAILY_ACCURACY_DIGEST_ENABLE
        value: "1"
      - key: DAILY_ACCURACY_HOUR
        value: "8"
      - key: DAILY_ACCURACY_MINUTE
        value: "0"
      - key: MOTD_ENABLE
        value: "1"
      - key: MOTD_HOUR
        value: "10"
      - key: MOTD_MINUTE
        value: "00"

      # ───── Odds / EV ─────
      - key: MIN_ODDS_OU
        value: "1.50"
      - key: MIN_ODDS_BTTS
        value: "1.50"
      - key: MIN_ODDS_1X2
        value: "1.50"
      - key: MAX_ODDS_ALL
        value: "20.0"
      - key: ODDS_CACHE_TTL_SEC
        value: "120"

      # ───── Telegram (flip SEND_MESSAGES when ready) ─────
      - key: TELEGRAM_BOT_TOKEN
        required: true
      - key: TELEGRAM_CHAT_ID
        required: true
      - key: TELEGRAM_PARSE_MODE
        value: "Markdown"
      - key: TELEGRAM_ALLOW_HTML_TAGS
        value: "0"
      - key: SEND_MESSAGES
        value: "false"

      # ───── Security ─────
      - key: ADMIN_API_KEY
        required: true
      - key: ALLOW_QUERY_KEY
        value: "0"

      # ───── DB session safety ─────
      - key: PG_STATEMENT_TIMEOUT_MS
        value: "15000"
      - key: PG_LOCK_TIMEOUT_MS
        value: "2000"
      - key: PG_IDLE_TX_TIMEOUT_MS
        value: "30000"
      - key: DB_SSLMODE_REQUIRE
        value: "1"

      # ───── Gunicorn tuning (consumed by gunicorn_conf.py) ─────
      - key: WEB_CONCURRENCY
        value: "1"
      - key: GTHREADS
        value: "4"
      - key: GUNICORN_TIMEOUT
        value: "120"
      - key: GUNICORN_GRACEFUL_TIMEOUT
        value: "30"
      - key: GUNICORN_KEEPALIVE
        value: "5"
      - key: GUNICORN_MAX_REQUESTS
        value: "1000"
      - key: GUNICORN_MAX_REQUESTS_JITTER
        value: "200"
      - key: GUNICORN_LOGLEVEL
        value: "info"
